# Миграции базы данных (Alembic)

Проект использует Alembic для управления миграциями базы данных.

## Установка

Убедитесь, что Alembic установлен:

```bash
pip install -r requirements.txt
```

## Инициализация (уже выполнено)

Структура Alembic уже инициализирована в `backend/alembic/`.

Конфигурация:
- `alembic.ini` - основной конфигурационный файл
- `alembic/env.py` - настройка подключения к БД (использует `settings.DATABASE_URL`)
- `alembic/versions/` - директория с файлами миграций

## Основные команды

### Применить все миграции

```bash
cd backend
alembic upgrade head
```

Эта команда применяет все неприменённые миграции до последней версии.

### Создать новую миграцию

При изменении моделей в `backend/models.py`:

```bash
cd backend
alembic revision --autogenerate -m "описание изменений"
```

Например:
```bash
alembic revision --autogenerate -m "add email field to users"
```

**Важно:** После создания миграции обязательно проверьте сгенерированный файл в `alembic/versions/` перед применением!

### Откатить последнюю миграцию

```bash
cd backend
alembic downgrade -1
```

### Просмотреть текущую версию

```bash
cd backend
alembic current
```

### Просмотреть историю миграций

```bash
cd backend
alembic history
```

## Работа с существующей БД

Если база данных уже существует (как в production), есть два варианта:

### Вариант 1: Пометить текущее состояние как применённое

Если БД уже содержит все таблицы и соответствует схеме:

```bash
cd backend
alembic stamp head
```

Эта команда создаст таблицу `alembic_version` и отметит текущую миграцию как применённую, **без выполнения SQL-команд**.

### Вариант 2: Применить миграцию

Если нужно создать недостающие таблицы:

```bash
cd backend
alembic upgrade head
```

**Важно:** 
- Всегда делайте резервную копию БД перед применением миграций в production!
- Если таблицы уже существуют, SQLite выдаст ошибку при попытке создать их повторно. В этом случае используйте `alembic stamp head`.

## Процесс разработки

1. Измените модели в `backend/models.py`
2. Создайте миграцию: `alembic revision --autogenerate -m "описание"`
3. Проверьте сгенерированный файл миграции
4. Примените миграцию: `alembic upgrade head`
5. Протестируйте изменения

## Важные замечания

- **Не используйте `Base.metadata.create_all()`** - все изменения схемы должны идти через миграции
- Миграции должны быть **безопасными** для существующих данных
- Не создавайте миграции, которые дропают таблицы или колонки без необходимости
- Всегда проверяйте миграции перед применением в production

